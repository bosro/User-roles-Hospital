<div class="p-4">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Invoices</h2>
    <p-button 
      label="Create Invoice" 
      icon="ri-add-line"
      routerLink="create">
    </p-button>
  </div>

  <!-- Filters -->
  <p-card styleClass="mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Status
        </label>
        <p-dropdown 
          [options]="statusOptions"
          [(ngModel)]="filters.status"
          (onChange)="applyFilters()"
          [style]="{'width':'100%'}"
          placeholder="All Statuses">
        </p-dropdown>
      </div>

      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Date Range
        </label>
        <div class="flex gap-2">
          <p-calendar 
            [(ngModel)]="filters.dateFrom"
            (onSelect)="applyFilters()"
            [showIcon]="true"
            placeholder="From"
            styleClass="w-full">
          </p-calendar>
          <p-calendar 
            [(ngModel)]="filters.dateTo"
            (onSelect)="applyFilters()"
            [showIcon]="true"
            placeholder="To"
            styleClass="w-full">
          </p-calendar>
        </div>
      </div>

      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Department
        </label>
        <p-dropdown 
          [options]="departments"
          [(ngModel)]="filters.department"
          (onChange)="applyFilters()"
          [style]="{'width':'100%'}"
          placeholder="All Departments">
        </p-dropdown>
      </div>

      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Search
        </label>
        <span class="p-input-icon-left w-full">
          <i class="ri-search-line"></i>
          <input 
            type="text" 
            pInputText 
            [(ngModel)]="filters.search"
            (input)="applyFilters()"
            placeholder="Search invoices..."
            class="w-full" />
        </span>
      </div>
    </div>
  </p-card>

  <!-- Invoices Table -->
  <p-card>
    <p-table 
      #dt
      [value]="invoices" 
      [rows]="10" 
      [paginator]="true"
      [globalFilterFields]="['invoiceNumber', 'patient.firstName', 'patient.lastName', 'doctor.firstName', 'doctor.lastName']"
      [loading]="loading"
      [rowHover]="true"
      dataKey="id"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} invoices"
      [tableStyle]="{'min-width': '75rem'}">

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="invoiceNumber">
            Invoice # <p-sortIcon field="invoiceNumber"></p-sortIcon>
          </th>
          <th pSortableColumn="patient.firstName">
            Patient <p-sortIcon field="patient.firstName"></p-sortIcon>
          </th>
          <th pSortableColumn="dateIssued">
            Date <p-sortIcon field="dateIssued"></p-sortIcon>
          </th>
          <th pSortableColumn="total">
            Amount <p-sortIcon field="total"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Status <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th>Insurance</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-invoice>
        <tr>
          <td>
            <a (click)="viewInvoice(invoice)" 
               class="text-blue-600 hover:text-blue-800 cursor-pointer">
              {{invoice.invoiceNumber}}
            </a>
          </td>
          <td>
            <div>{{invoice.patient ? invoice.patient.firstName + ' ' + invoice.patient.lastName : 'Unknown Patient'}}</div>
            <div class="text-sm text-gray-500">
              Dr. {{invoice.doctor ? invoice.doctor.firstName + ' ' + invoice.doctor.lastName : 'Unknown Doctor'}}
            </div>
          </td>
          <td>
            <div>{{invoice.dateIssued | date}}</div>
            <div class="text-sm text-gray-500">
              Due: {{invoice.dueDate | date}}
            </div>
          </td>
          <td>
            <div>GHC {{(invoice.total || invoice.totalAmount || 0).toLocaleString()}}</div>
            <div class="text-sm" [class]="getBalanceClass(invoice)">
              Balance: GHC {{invoice.balance.toLocaleString()}}
            </div>
          </td>
          <td>
            <span [class]="getStatusClass(invoice.status)">
              {{invoice.status}}
            </span>
          </td>
          <td>
            <div *ngIf="invoice.insuranceClaim">
              <span [class]="getInsuranceStatusClass(invoice.insuranceClaim.status)">
                {{invoice.insuranceClaim.status}}
              </span>
              <div class="text-sm text-gray-500">
                GHC {{invoice.insuranceClaim.coverageAmount.toLocaleString()}}
              </div>
            </div>
            <span *ngIf="!invoice.insuranceClaim" class="text-gray-500">
              No claim
            </span>
          </td>
          <td>
            <div class="flex gap-2">
              <p-button 
                icon="ri-eye-line" 
                severity="secondary"
                tooltipPosition="top"
                pTooltip="View Details"
                (onClick)="viewInvoice(invoice)">
              </p-button>
              <p-button 
                icon="ri-edit-line" 
                severity="secondary"
                tooltipPosition="top"
                pTooltip="Edit Invoice"
                (onClick)="editInvoice(invoice)"
                [disabled]="invoice.status.toLowerCase() === 'paid'">
              </p-button>
              <p-button 
                icon="ri-delete-bin-line" 
                severity="danger"
                tooltipPosition="top"
                pTooltip="Delete Invoice"
                (onClick)="confirmDelete(invoice)"
                [disabled]="invoice.status.toLowerCase() === 'paid'">
              </p-button>
              <p-button 
                icon="ri-money-dollar-circle-line" 
                severity="success"
                tooltipPosition="top"
                pTooltip="Record Payment"
                (onClick)="recordPayment(invoice)"
                [disabled]="invoice.status.toLowerCase() === 'paid' || invoice.status.toLowerCase() === 'cancelled'">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="summary">
        <div class="flex justify-between items-center">
          <div>Total Invoices: {{invoices.length}}</div>
          <div class="text-sm">
            Total Amount: ${{getTotalAmount() | number:'1.2-2'}} | 
            Outstanding: ${{getOutstandingAmount() | number:'1.2-2'}}
          </div>
        </div>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Payment Dialog -->
<p-dialog 
  [(visible)]="showPaymentDialog" 
  [header]="'Record Payment - ' + (selectedInvoice?.invoiceNumber || '')"
  [modal]="true"
  [style]="{width: '450px'}">
  <form [formGroup]="paymentForm" (ngSubmit)="submitPayment()">
    <div class="grid grid-cols-1 gap-4 mb-4">
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Payment Amount *
        </label>
        <p-inputNumber 
          formControlName="amount" 
          mode="currency" 
          currency="USD" 
          [showButtons]="false"
          [style]="{'width':'100%'}"
          [min]="0.01">
        </p-inputNumber>
        <small class="text-gray-500">Current balance: GHC {{selectedInvoice?.balance}}</small>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Payment Date *
        </label>
        <p-calendar 
          formControlName="paymentDate"
          [showIcon]="true"
          [style]="{'width':'100%'}">
        </p-calendar>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Payment Method *
        </label>
        <p-dropdown 
          formControlName="paymentMethod"
          [options]="paymentMethods"
          [style]="{'width':'100%'}">
        </p-dropdown>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Reference/Transaction ID
        </label>
        <input 
          type="text" 
          pInputText 
          formControlName="reference"
          placeholder="e.g., Check #, Transaction ID"
          class="w-full" />
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Notes
        </label>
        <textarea 
          pInputTextarea 
          formControlName="notes"
          placeholder="Add any payment notes here"
          class="w-full" 
          rows="3">
        </textarea>
      </div>
    </div>
    
    <div class="flex justify-end">
      <p-button 
        label="Cancel" 
        icon="ri-close-line"
        styleClass="p-button-text"
        (onClick)="showPaymentDialog = false">
      </p-button>
      <p-button 
        type="submit"
        label="Record Payment" 
        icon="ri-check-line"
        styleClass="ml-2"
        [disabled]="!paymentForm.valid">
      </p-button>
    </div>
  </form>
</p-dialog>

<!-- View Invoice Dialog -->
<p-dialog 
  [(visible)]="showViewDialog" 
  [header]="'Invoice Details - ' + (selectedInvoice?.invoiceNumber || '')"
  [modal]="true"
  [style]="{width: '700px'}"
  [maximizable]="true">
  <div *ngIf="selectedInvoice" class="grid grid-cols-1 gap-4">
    <!-- Invoice Header -->
    <div class="flex justify-between items-start">
      <div>
        <h3 class="text-xl font-bold">Invoice #{{selectedInvoice.invoiceNumber}}</h3>
        <p class="text-gray-500">Status: 
          <span [class]="getStatusClass(selectedInvoice.status)">
            {{selectedInvoice.status}}
          </span>
        </p>
      </div>
      <div class="text-right">
        <p><strong>Date:</strong> {{selectedInvoice.dateIssued | date}}</p>
        <p><strong>Due Date:</strong> {{selectedInvoice.dueDate | date}}</p>
      </div>
    </div>
    
    <!-- Patient & Doctor Info -->
    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded">
      <div>
        <h4 class="font-bold">Patient</h4>
        <p>{{getPatientFullName(selectedInvoice)}}</p>
        <!-- Add more patient details if available -->
        <!-- <div *ngIf="selectedInvoice.patient?.contactInfo">
          <p class="text-sm text-gray-600 mt-1">{{selectedInvoice.patient.contactInfo.phone}}</p>
          <p class="text-sm text-gray-600">{{selectedInvoice.patient.contactInfo.email}}</p>
        </div> -->
      </div>
      <div>
        <h4 class="font-bold">Doctor</h4>
        <p>Dr. {{getDoctorFullName(selectedInvoice)}}</p>
        <!-- Add more doctor details if available -->
        <!-- <p *ngIf="selectedInvoice.doctor?.department" class="text-sm text-gray-600 mt-1">
          Department: {{selectedInvoice.doctor.department}}
        </p> -->
      </div>
    </div>
    
    <!-- Invoice Items -->
    <div>
      <h4 class="font-bold mb-2">Services/Items</h4>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-2 text-left">Description</th>
            <th class="p-2 text-right">Qty</th>
            <th class="p-2 text-right">Unit Price</th>
            <th class="p-2 text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of selectedInvoice.items" class="border-b">
            <td class="p-2">{{item.description}}</td>
            <td class="p-2 text-right">{{item.quantity}}</td>
            <td class="p-2 text-right">${{item.unitPrice.toLocaleString()}}</td>
            <td class="p-2 text-right">${{item.amount.toLocaleString()}}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="border-t-2">
            <td colspan="3" class="p-2 text-right font-bold">Subtotal:</td>
            <td class="p-2 text-right">${{selectedInvoice.subtotal.toLocaleString()}}</td>
          </tr>
          <tr>
            <td colspan="3" class="p-2 text-right">Tax:</td>
            <td class="p-2 text-right">${{selectedInvoice.tax.toLocaleString()}}</td>
          </tr>
          <tr>
            <td colspan="3" class="p-2 text-right">Discount:</td>
            <td class="p-2 text-right">-${{selectedInvoice.discount.toLocaleString()}}</td>
          </tr>
          <tr class="bg-gray-100">
            <td colspan="3" class="p-2 text-right font-bold">Total:</td>
            <td class="p-2 text-right font-bold">${{(selectedInvoice.total || selectedInvoice.totalAmount || 0).toLocaleString()}}</td>
          </tr>
          <tr class="font-bold" [class]="getBalanceClass(selectedInvoice)">
            <td colspan="3" class="p-2 text-right">Balance Due:</td>
            <td class="p-2 text-right">${{selectedInvoice.balance.toLocaleString()}}</td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <!-- Insurance Info -->
    <div *ngIf="selectedInvoice.insuranceClaim" class="bg-blue-50 p-3 rounded">
      <h4 class="font-bold mb-2">Insurance Information</h4>
      <p><strong>Status:</strong> 
        <span [class]="getInsuranceStatusClass(selectedInvoice.insuranceClaim.status)">
          {{selectedInvoice.insuranceClaim.status}}
        </span>
      </p>
      <p><strong>Coverage Amount:</strong> ${{selectedInvoice.insuranceClaim.coverageAmount.toLocaleString()}}</p>
      <p *ngIf="selectedInvoice.insuranceClaim.provider"><strong>Provider:</strong> {{selectedInvoice.insuranceClaim.provider}}</p>
      <p *ngIf="selectedInvoice.insuranceClaim.policyNumber"><strong>Policy Number:</strong> {{selectedInvoice.insuranceClaim.policyNumber}}</p>
    </div>
    
    <!-- Patient Insurance Info (if available) -->
    <!-- <div *ngIf="selectedInvoice.patient?.insurance" class="bg-blue-50 p-3 rounded">
      <h4 class="font-bold mb-2">Patient Insurance Information</h4>
      <p><strong>Provider:</strong> {{selectedInvoice.patient.insurance.provider}}</p>
      <p><strong>Policy Number:</strong> {{selectedInvoice.patient.insurance.policyNumber}}</p>
      <p><strong>Valid Till:</strong> {{selectedInvoice.patient.insurance.validTill | date}}</p>
    </div> -->
    
    <!-- Notes -->
    <div *ngIf="selectedInvoice.notes" class="bg-gray-50 p-3 rounded">
      <h4 class="font-bold mb-2">Notes</h4>
      <p>{{selectedInvoice.notes}}</p>
    </div>
    
    <div class="flex justify-end gap-2">
      <p-button 
        label="Close" 
        icon="ri-close-line"
        styleClass="p-button-text"
        (onClick)="showViewDialog = false">
      </p-button>
      <p-button 
        *ngIf="selectedInvoice.status.toLowerCase() !== 'paid' && selectedInvoice.status.toLowerCase() !== 'cancelled'"
        label="Record Payment" 
        icon="ri-money-dollar-circle-line"
        severity="success"
        (onClick)="recordPayment(selectedInvoice); showViewDialog = false">
      </p-button>
    </div>
  </div>
</p-dialog>

<!-- Edit Invoice Dialog -->
<p-dialog 
  [(visible)]="showEditDialog" 
  [header]="'Edit Invoice - ' + (selectedInvoice?.invoiceNumber || '')"
  [modal]="true"
  [style]="{width: '500px'}">
  <form *ngIf="selectedInvoice" [formGroup]="editForm" (ngSubmit)="saveInvoiceEdit()">
    <div class="grid grid-cols-1 gap-4 mb-4">
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Issue Date *
        </label>
        <p-calendar 
          formControlName="issueDate"
          [showIcon]="true"
          [style]="{'width':'100%'}">
        </p-calendar>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Due Date *
        </label>
        <p-calendar 
          formControlName="dueDate"
          [showIcon]="true"
          [style]="{'width':'100%'}">
        </p-calendar>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Status *
        </label>
        <p-dropdown 
          formControlName="status"
          [options]="statusOptions"
          [style]="{'width':'100%'}">
        </p-dropdown>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Discount
        </label>
        <p-inputNumber 
          formControlName="discount" 
          mode="currency" 
          currency="USD" 
          [showButtons]="false"
          [style]="{'width':'100%'}"
          [min]="0">
        </p-inputNumber>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Tax
        </label>
        <p-inputNumber 
          formControlName="tax" 
          mode="currency" 
          currency="USD" 
          [showButtons]="false"
          [style]="{'width':'100%'}"
          [min]="0">
        </p-inputNumber>
      </div>
      
      <div class="field">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Notes
        </label>
        <textarea 
          pInputTextarea 
          formControlName="notes"
          placeholder="Add any invoice notes here"
          class="w-full" 
          rows="3">
        </textarea>
      </div>
    </div>
    
    <div class="flex justify-end">
      <p-button 
        label="Cancel" 
        icon="ri-close-line"
        styleClass="p-button-text"
        (onClick)="showEditDialog = false">
      </p-button>
      <p-button 
        type="submit"
        label="Save Changes" 
        icon="ri-check-line"
        styleClass="ml-2"
        [disabled]="!editForm.valid">
      </p-button>
    </div>
  </form>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
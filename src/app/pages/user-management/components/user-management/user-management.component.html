<div class="p-4">
  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <p-card styleClass="border-0 shadow-sm">
      <div class="flex items-center">
        <i class="ri-user-line text-3xl mr-3 text-blue-500"></i>
        <div>
          <h3 class="text-xl font-semibold">{{userStats.totalUsers}}</h3>
          <p class="text-gray-600">Total Users</p>
        </div>
      </div>
    </p-card>

    <p-card styleClass="border-0 shadow-sm">
      <div class="flex items-center">
        <i class="ri-user-add-line text-3xl mr-3 text-green-500"></i>
        <div>
          <h3 class="text-xl font-semibold">{{userStats.activeUsers}}</h3>
          <p class="text-gray-600">Active Users</p>
        </div>
      </div>
    </p-card>

    <p-card styleClass="border-0 shadow-sm">
      <div class="flex items-center">
        <i class="ri-time-line text-3xl mr-3 text-orange-500"></i>
        <div>
          <h3 class="text-xl font-semibold">{{userStats.pendingUsers}}</h3>
          <p class="text-gray-600">Pending Approvals</p>
        </div>
      </div>
    </p-card>

    <p-card styleClass="border-0 shadow-sm">
      <div class="flex items-center">
        <i class="ri-shield-keyhole-line text-3xl mr-3 text-purple-500"></i>
        <div>
          <h3 class="text-xl font-semibold">{{userStats.onlineUsers}}</h3>
          <p class="text-gray-600">Online Now</p>
        </div>
      </div>
    </p-card>
  </div>

  <!-- User List -->
  <p-card styleClass="shadow-sm">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
      <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
      <div class="flex gap-2">
        <p-button 
          label="Import Users" 
          icon="ri-file-upload-line"
          severity="secondary"
          styleClass="p-button-rounded"
          (onClick)="showImportDialog()">
        </p-button>
        <p-button 
          label="Add User" 
          icon="ri-user-add-line"
          styleClass="p-button-rounded"
          (onClick)="showUserDialog()">
        </p-button>
      </div>
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <span class="p-input-icon-left w-full">
        <i class="ri-search-line"></i>
        <input 
          pInputText 
          type="text" 
          [(ngModel)]="filters.search"
          (input)="onSearch($event)"
          placeholder="Search users..."
          class="w-full rounded-lg" />
      </span>

      <p-dropdown 
        [options]="roles"
        [(ngModel)]="filters.role"
        (onChange)="filterUsers()"
        placeholder="Select Role"
        [showClear]="true"
        styleClass="w-full">
      </p-dropdown>

      <p-dropdown 
        [options]="departments"
        [(ngModel)]="filters.department"
        (onChange)="filterUsers()"
        placeholder="Select Department"
        [showClear]="true"
        styleClass="w-full">
      </p-dropdown>

      <p-dropdown 
        [options]="statuses"
        [(ngModel)]="filters.status"
        (onChange)="filterUsers()"
        placeholder="Select Status"
        [showClear]="true"
        styleClass="w-full">
      </p-dropdown>
    </div>

    <p-table 
      #dt
      [value]="users" 
      [rows]="10" 
      [paginator]="true"
      [loading]="loading"
      [rowHover]="true"
      styleClass="p-datatable-rounded p-datatable-gridlines"
      dataKey="id"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
      [rowsPerPageOptions]="[10,25,50]"
      [globalFilterFields]="['firstName','lastName','email','role','department']">

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="firstName" class="text-left">
            User <p-sortIcon field="firstName"></p-sortIcon>
          </th>
          <th pSortableColumn="role" class="text-left">
            Role <p-sortIcon field="role"></p-sortIcon>
          </th>
          <th pSortableColumn="department" class="text-left">
            Department <p-sortIcon field="department"></p-sortIcon>
          </th>
          <th pSortableColumn="status" class="text-left">
            Status <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th pSortableColumn="lastLogin" class="text-left">
            Last Login <p-sortIcon field="lastLogin"></p-sortIcon>
          </th>
          <th class="text-center">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user>
        <tr>
          <td>
            <div class="flex items-center">
              <p-avatar 
                [image]="user.profileImage" 
                [label]="getUserInitials(user)"
                styleClass="mr-2"
                [ngClass]="user.role === 'SUPER_ADMIN' ? 'bg-purple-600' : 'bg-blue-600'"
                shape="circle"
                [style]="{'width': '36px', 'height': '36px'}">
              </p-avatar>
              <div>
                <div class="font-medium">
                  {{user.firstName}} {{user.lastName}}
                </div>
                <div class="text-sm text-gray-500">{{user.email}}</div>
              </div>
            </div>
          </td>
          <td>
            <span [class]="getRoleClass(user.role)">
              {{user.role.replace('_', ' ')}}
            </span>
          </td>
          <td>{{user.department}}</td>
          <td>
            <span [class]="getStatusClass(user.status)">
              {{user.status | titlecase}}
            </span>
          </td>
          <td>
            <div class="text-sm">
              {{user.lastLogin | date:'MMM d, y, h:mm a'}}
            </div>
          </td>
          <td>
            <div class="flex justify-center gap-2">
              <p-button 
                icon="ri-eye-line" 
                severity="secondary"
                styleClass="p-button-rounded p-button-text"
                (onClick)="viewUser(user)"
                pTooltip="View Details">
              </p-button>
              <p-button 
                icon="ri-edit-line" 
                severity="secondary"
                styleClass="p-button-rounded p-button-text"
                (onClick)="editUser(user)"
                pTooltip="Edit User">
              </p-button>
              <p-button 
                icon="ri-lock-line" 
                severity="secondary"
                styleClass="p-button-rounded p-button-text"
                (onClick)="resetPassword(user)"
                pTooltip="Reset Password">
              </p-button>
              <!-- Block/Unblock button with loading state -->
              <p-button 
                [icon]="user.status === 'active' ? 'ri-lock-line' : 'ri-lock-unlock-line'"
                [loading]="(user.status === 'active' && blockingUser) || (user.status !== 'active' && unblockingUser)"
                [severity]="user.status === 'active' ? 'danger' : 'success'"
                styleClass="p-button-rounded p-button-text"
                (onClick)="toggleUserStatus(user)"
                [pTooltip]="user.status === 'active' ? 'Block User' : 'Unblock User'">
              </p-button>
              
              <!-- Admin Role Buttons -->
              <p-button 
                *ngIf="user.role !== 'ADMIN' && user.role !== 'SUPER_ADMIN'"
                icon="ri-user-star-line" 
                severity="info"
                styleClass="p-button-rounded p-button-text"
                (onClick)="promoteToAdmin(user.id)"
                pTooltip="Promote to Admin">
              </p-button>
              <p-button 
                *ngIf="user.role === 'ADMIN'"
                icon="ri-user-unfollow-line" 
                severity="warn"
                styleClass="p-button-rounded p-button-text"
                (onClick)="demoteFromAdmin(user.id)"
                pTooltip="Remove Admin Role">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center p-6">
            <div class="flex flex-col items-center">
              <i class="ri-user-search-line text-4xl text-gray-400 mb-2"></i>
              <span class="text-gray-500">No users found.</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- User Dialog -->
<!-- User Dialog -->
<p-dialog 
  [(visible)]="displayUserDialog" 
  [header]="selectedUser ? 'Edit User' : 'Add New User'"
  [modal]="true"
  [style]="{width: '750px'}"
  [draggable]="false"
  styleClass="p-dialog-rounded shadow-lg">
  
  <!-- User Form -->
  <div class="p-6 bg-gray-50 rounded-lg">
    <div class="mb-6 flex items-center justify-center" *ngIf="!selectedUser">
      <div class="bg-blue-100 rounded-full p-4">
        <i class="ri-user-add-line text-4xl text-blue-600"></i>
      </div>
    </div>
    <div class="mb-6 flex items-center justify-center" *ngIf="selectedUser">
      <p-avatar 
        [image]="selectedUser?.profileImage" 
        [label]="selectedUser ? getUserInitials(selectedUser) : ''"
        styleClass="mr-2"
        [ngClass]="selectedUser?.role === 'SUPER_ADMIN' ? 'bg-purple-600' : 'bg-blue-600'"
        shape="circle"
        size="xlarge">
      </p-avatar>
    </div>
    
    <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="p-fluid">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- First Name -->
        <div class="space-y-2">
          <label for="firstName" class="text-sm font-medium text-gray-700 flex items-center">
            First Name
            <span class="text-red-500 ml-1">*</span>
          </label>
          <input 
            id="firstName" 
            type="text" 
            pInputText 
            formControlName="firstName"
            class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
          />
          <small 
            *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched" 
            class="text-red-500 text-xs flex items-center mt-1">
            <i class="ri-error-warning-line mr-1"></i> First name is required
          </small>
        </div>

        <!-- Last Name -->
        <div class="space-y-2">
          <label for="lastName" class="text-sm font-medium text-gray-700 flex items-center">
            Last Name
            <span class="text-red-500 ml-1">*</span>
          </label>
          <input 
            id="lastName" 
            type="text" 
            pInputText 
            formControlName="lastName"
            class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
          />
          <small 
            *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched" 
            class="text-red-500 text-xs flex items-center mt-1">
            <i class="ri-error-warning-line mr-1"></i> Last name is required
          </small>
        </div>

        <!-- Email - Full Width -->
        <div class="space-y-2 col-span-1 md:col-span-2">
          <label for="email" class="text-sm font-medium text-gray-700 flex items-center">
            Email Address
            <span class="text-red-500 ml-1">*</span>
          </label>
          <div class="relative w-full">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <i class="ri-mail-line text-gray-400"></i>
            </span>
            <input 
              id="email" 
              type="email" 
              pInputText 
              formControlName="email"
              class="w-full pl-10 px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
            />
          </div>
          <small 
            *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched" 
            class="text-red-500 text-xs flex items-center mt-1">
            <i class="ri-error-warning-line mr-1"></i> Valid email is required
          </small>
        </div>

        <!-- Role -->
        <div class="space-y-2">
          <label for="role" class="text-sm font-medium text-gray-700 flex items-center">
            Role
            <span class="text-red-500 ml-1">*</span>
          </label>
          <p-dropdown 
            id="role" 
            [options]="roles" 
            formControlName="role" 
            placeholder="Select Role" 
            optionLabel="label" 
            optionValue="value"
            styleClass="w-full rounded-md shadow-sm">
          </p-dropdown>
          <small 
            *ngIf="userForm.get('role')?.invalid && userForm.get('role')?.touched" 
            class="text-red-500 text-xs flex items-center mt-1">
            <i class="ri-error-warning-line mr-1"></i> Role is required
          </small>
        </div>

        <!-- Department -->
        <div class="space-y-2">
          <label for="department" class="text-sm font-medium text-gray-700 flex items-center">
            Department
            <span class="text-red-500 ml-1">*</span>
          </label>
          <p-dropdown 
            id="department" 
            [options]="departments" 
            formControlName="department" 
            placeholder="Select Department" 
            optionLabel="label" 
            optionValue="value"
            styleClass="w-full rounded-md shadow-sm">
          </p-dropdown>
          <small 
            *ngIf="userForm.get('department')?.invalid && userForm.get('department')?.touched" 
            class="text-red-500 text-xs flex items-center mt-1">
            <i class="ri-error-warning-line mr-1"></i> Department is required
          </small>
        </div>

        <!-- Divider -->
        <div class="col-span-1 md:col-span-2 mt-2">
          <div class="border-t border-gray-200 my-4"></div>
          <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-4">Additional Information</h3>
        </div>

        <!-- Languages -->
        <div class="space-y-2 col-span-1 md:col-span-2">
          <label for="languages" class="text-sm font-medium text-gray-700 flex items-center">
            Languages
            <span class="text-gray-400 text-xs ml-2">(Optional)</span>
          </label>
          <p-multiSelect 
            id="languages" 
            [options]="languageOptions" 
            formControlName="languages" 
            placeholder="Select Languages" 
            optionLabel="name" 
            optionValue="code" 
            display="chip"
            styleClass="w-full rounded-md shadow-sm">
          </p-multiSelect>
        </div>

        <!-- Working Days -->
        <div class="space-y-2 col-span-1 md:col-span-2">
          <label for="workingDays" class="text-sm font-medium text-gray-700 flex items-center">
            Working Days
            <span class="text-gray-400 text-xs ml-2">(Optional)</span>
          </label>
          <p-multiSelect 
            id="workingDays" 
            [options]="workingDaysOptions" 
            formControlName="workingDays" 
            placeholder="Select Working Days" 
            optionLabel="name" 
            optionValue="code" 
            display="chip"
            styleClass="w-full rounded-md shadow-sm">
          </p-multiSelect>
        </div>

        <!-- Password - Only for new users -->
        <div *ngIf="!selectedUser" class="space-y-2 col-span-1 md:col-span-2">
          <label for="password" class="text-sm font-medium text-gray-700 flex items-center">
            Password
            <span class="text-red-500 ml-1">*</span>
          </label>
          <p-password 
            id="password" 
            formControlName="password" 
            [toggleMask]="true" 
            [feedback]="true" 
            styleClass="w-full rounded-md shadow-sm">
          </p-password>
          <small 
            *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched" 
            class="text-red-500 text-xs flex items-center mt-1">
            <i class="ri-error-warning-line mr-1"></i> Password is required (minimum 8 characters)
          </small>
        </div>

        <!-- Form Actions -->
        <div class="col-span-1 md:col-span-2 flex items-center justify-end space-x-4 mt-6 pt-4 border-t border-gray-200">
          <p-button 
            type="button" 
            label="Cancel" 
            (click)="displayUserDialog = false" 
            styleClass="p-button-outlined p-button-secondary hover:bg-gray-100 transition-colors">
          </p-button>
          <p-button 
            type="submit" 
            label="Save" 
            [disabled]="userForm.invalid" 
            icon="ri-save-line"
            styleClass="bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all">
          </p-button>
        </div>
      </div>
    </form>
  </div>
</p-dialog>

  <!-- Import Dialog -->
  <p-dialog 
    [(visible)]="displayImportDialog" 
    header="Import Users"
    [modal]="true"
    [style]="{width: '550px'}"
    [draggable]="false"
    styleClass="p-dialog-rounded">
    <!-- Import Form -->
    <div class="p-4">
      <div class="field">
        <label for="importFile">Upload CSV File</label>
        <div class="p-inputgroup">
          <input type="file" accept=".csv" (change)="onFileSelected($event)" class="hidden" id="importFile" #fileInput/>
          <span class="p-inputgroup-addon">
            <i class="ri-file-excel-line"></i>
          </span>
          <input type="text" pInputText [value]="selectedFileName || 'No file selected'" readonly />
          <button type="button" pButton icon="ri-folder-upload-line" (click)="fileInput.click()"></button>
        </div>
        <small class="text-gray-500 mt-2 block">Upload a CSV file with the following headers: firstName, lastName, email, role, department</small>
      </div>

      <div *ngIf="uploadedPreview.length > 0" class="mt-4">
        <h4 class="text-lg font-medium mb-2">Preview (First 5 records)</h4>
        <p-table [value]="uploadedPreview" styleClass="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-user>
            <tr>
              <td>{{user.firstName}} {{user.lastName}}</td>
              <td>{{user.email}}</td>
              <td>{{user.role}}</td>
              <td>{{user.department}}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
      
      <div class="flex justify-content-end gap-2 mt-4">
        <p-button type="button" label="Cancel" (click)="displayImportDialog = false" styleClass="p-button-outlined p-button-secondary"></p-button>
        <p-button type="button" label="Import" [disabled]="!selectedFile" icon="ri-upload-line" (click)="importUsers()"></p-button>
      </div>
    </div>
  </p-dialog>

  <!-- View User Dialog -->
  <p-dialog 
    [(visible)]="displayViewDialog" 
    [header]="selectedUser ? selectedUser.firstName + ' ' + selectedUser.lastName : ''"
    [modal]="true"
    [style]="{width: '800px'}"
    [draggable]="false"
    styleClass="p-dialog-rounded">
    <!-- User Details View -->
    <div *ngIf="selectedUser" class="p-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex flex-col items-center text-center">
          <p-avatar 
            [image]="selectedUser.profileImage" 
            [label]="getUserInitials(selectedUser)"
            [ngClass]="selectedUser.role === 'SUPER_ADMIN' ? 'bg-purple-600' : 'bg-blue-600'"
            shape="circle"
            size="xlarge"
            class="mb-4">
          </p-avatar>
          <h3 class="text-xl font-bold">{{selectedUser.firstName}} {{selectedUser.lastName}}</h3>
          <p class="text-gray-600">{{selectedUser.email}}</p>
          <span [class]="getRoleClass(selectedUser.role)" class="mt-2">
            {{selectedUser.role.replace('_', ' ')}}
          </span>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-4">User Information</h4>
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between py-2 border-b border-gray-200">
              <span class="text-gray-600">Department:</span>
              <span class="font-medium">{{selectedUser.department}}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-200">
              <span class="text-gray-600">Status:</span>
              <span [class]="getStatusClass(selectedUser.status)">
                {{selectedUser.status | titlecase}}
              </span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-200">
              <span class="text-gray-600">Last Login:</span>
              <span>{{selectedUser.lastLogin | date:'medium'}}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-200">
              <span class="text-gray-600">Created On:</span>
              <span>{{selectedUser.createdAt | date:'medium'}}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-200" *ngIf="selectedUser.languages?.length">
              <span class="text-gray-600">Languages:</span>
              <span>
                <p-tag *ngFor="let lang of selectedUser.languages" styleClass="mr-1" severity="info">
                  {{lang}}
                </p-tag>
              </span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-200" *ngIf="selectedUser.workingDays?.length">
              <span class="text-gray-600">Working Days:</span>
              <span>
                <p-tag *ngFor="let day of selectedUser.workingDays" styleClass="mr-1" severity="success">
                  {{day}}
                </p-tag>
              </span>
            </div>
          </div>
          
          <div class="flex gap-2 mt-4">
            <p-button 
              icon="ri-edit-line" 
              label="Edit" 
              (onClick)="editUser(selectedUser); displayViewDialog = false">
            </p-button>
            
            <!-- Block/Unblock button in user details with loading state -->
            <p-button 
              [icon]="selectedUser.status === 'active' ? 'ri-lock-line' : 'ri-lock-unlock-line'"
              [label]="selectedUser.status === 'active' ? 'Block' : 'Unblock'"
              [loading]="(selectedUser.status === 'active' && blockingUser) || (selectedUser.status !== 'active' && unblockingUser)"
              [severity]="selectedUser.status === 'active' ? 'danger' : 'success'"
              (onClick)="toggleUserStatus(selectedUser); displayViewDialog = false">
            </p-button>
            
            <!-- Admin promotion button -->
            <p-button
              *ngIf="selectedUser.role !== 'ADMIN' && selectedUser.role !== 'SUPER_ADMIN'"
              icon="ri-user-star-line"
              label="Promote to Admin"
              severity="info"
              (onClick)="promoteToAdmin(selectedUser.id); displayViewDialog = false">
            </p-button>
            
            <!-- Admin demotion button -->
            <p-button
              *ngIf="selectedUser.role === 'ADMIN'"
              icon="ri-user-unfollow-line"
              label="Remove Admin"
              severity="warn"
              (onClick)="demoteFromAdmin(selectedUser.id); displayViewDialog = false">
            </p-button>
          </div>
        </div>
      </div>
    </div>
  </p-dialog>

  <!-- Reset Password Dialog -->
  <p-dialog 
    [(visible)]="displayResetDialog" 
    header="Reset Password"
    [modal]="true"
    [style]="{width: '400px'}"
    [draggable]="false"
    styleClass="p-dialog-rounded">
    <!-- Reset Password Form -->
    <form [formGroup]="resetPasswordForm" (ngSubmit)="resetUserPassword()" class="p-fluid">
      <div class="field">
        <label for="newPassword">New Password*</label>
        <p-password id="newPassword" formControlName="newPassword" [toggleMask]="true" [feedback]="true" styleClass="w-full"></p-password>
        <small *ngIf="resetPasswordForm.get('newPassword')?.invalid && resetPasswordForm.get('newPassword')?.touched" class="p-error">Password must be at least 8 characters</small>
      </div>
      
      <div class="field">
        <label for="confirmPassword">Confirm Password*</label>
        <p-password id="confirmPassword" formControlName="confirmPassword" [toggleMask]="true" styleClass="w-full"></p-password>
        <small *ngIf="resetPasswordForm.get('confirmPassword')?.invalid && resetPasswordForm.get('confirmPassword')?.touched" class="p-error">Please confirm password</small>
        <small *ngIf="resetPasswordForm.hasError('notMatched') && resetPasswordForm.get('confirmPassword')?.touched" class="p-error">Passwords must match</small>
      </div>

      <div class="flex justify-content-end gap-2 mt-4">
        <p-button type="button" label="Cancel" (click)="displayResetDialog = false" styleClass="p-button-outlined p-button-secondary"></p-button>
        <p-button type="submit" label="Reset Password" [disabled]="resetPasswordForm.invalid" icon="ri-lock-unlock-line"></p-button>
      </div>
    </form>
  </p-dialog>

  <p-confirmDialog styleClass="p-dialog-rounded"></p-confirmDialog>
  <p-toast></p-toast>
</div>
<div class="p-4">
  <!-- Profile Header -->
  <p-card class="mb-6">
    <div class="md:flex items-center gap-8">
      <div class="flex-shrink-0 text-center mb-4 md:mb-0">
        <div class="relative inline-block">
          <p-avatar [image]="userProfile.profileImage" size="xlarge" shape="circle"
            [style]="{'width': '150px', 'height': '150px'}" class="mb-2">
            <ng-container *ngIf="!userProfile.profileImage">
              {{ userProfile.firstName.charAt(0) }}{{ userProfile.lastName.charAt(0) }}
            </ng-container>
          </p-avatar>
          <button class="absolute bottom-0 right-0 bg-white rounded-full p-2 shadow-lg border hover:bg-gray-50"
            (click)="showPhotoDialog()">
            <i class="ri-camera-line text-xl text-gray-600"></i>
          </button>
        </div>
        <h2 class="text-xl font-bold mt-2">
          <ng-container [ngSwitch]="userProfile.role.toLowerCase()">
            <span *ngSwitchCase="'doctor'">Dr. </span>
            <span *ngSwitchCase="'nurse'">Nurse </span>
          </ng-container>
          {{userProfile.firstName}} {{userProfile.lastName}}
        </h2>
        <!-- <p class="text-gray-600">{{userProfile.specialization}} - {{getRoleTitle(userProfile.role)}}</p> -->
      </div>

      <!-- Stats for a doctor -->
      <!-- <div class="flex-grow" *ngIf="userProfile.role.toLowerCase() === 'doctor'">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="text-center p-4 rounded-lg bg-blue-50 hover:bg-blue-100">
            <h3 class="text-2xl font-bold text-blue-600">{{userProfile.experience}} yrs</h3>
            <p class="text-gray-600">Experience</p>
          </div>
          <div class="text-center p-4 rounded-lg bg-green-50 hover:bg-green-100">
            <h3 class="text-2xl font-bold text-green-600">${{userProfile.consultationFee}}</h3>
            <p class="text-gray-600">Consultation Fee</p>
          </div>
          <div class="text-center p-4 rounded-lg bg-purple-50 hover:bg-purple-100">
            <h3 class="text-2xl font-bold text-purple-600">{{userProfile.qualification}}</h3>
            <p class="text-gray-600">Qualification</p>
          </div>
        </div>
      </div> -->
    </div>
  </p-card>

  <!-- Tabs -->
  <p-tabView>
    <!-- Personal Information Tab -->
    <p-tabPanel header="Personal Information">
      <div class="p-4 bg-gray-50 rounded-lg">
        <form [formGroup]="personalForm" class="space-y-6" (ngSubmit)="updatePersonalInfo()">
          <!-- Basic Fields -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
              <input pInputText formControlName="firstName" class="w-full" />
              <small class="text-red-500" *ngIf="showFieldError('firstName')">Required</small>
            </div>

            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
              <input pInputText formControlName="lastName" class="w-full" />
              <small class="text-red-500" *ngIf="showFieldError('lastName')">Required</small>
            </div>

            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input pInputText formControlName="email" type="email" class="w-full" />
              <small class="text-red-500" *ngIf="showFieldError('email')">Valid email required</small>
            </div>

            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
              <input pInputText formControlName="phone" class="w-full" />
              <small class="text-red-500" *ngIf="showFieldError('phone')">Required</small>
            </div>

            <!-- Doctor-Specific Fields -->
            <ng-container *ngIf="userProfile.role.toLowerCase() === 'doctor'">
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">License Number</label>
                <input pInputText formControlName="licenseNumber" class="w-full" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Specialization</label>
                <input pInputText formControlName="specialization" class="w-full" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Qualification</label>
                <input pInputText formControlName="qualification" class="w-full" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Experience (years)</label>
                <p-inputNumber formControlName="experience" class="w-full"></p-inputNumber>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Consultation Fee</label>
                <p-inputNumber formControlName="consultationFee" mode="currency" currency="USD" class="w-full">
                </p-inputNumber>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Languages</label>
                <p-chips formControlName="languages" class="w-full"></p-chips>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Working Days</label>
                <p-chips formControlName="workingDays" class="w-full"></p-chips>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                <input pInputText formControlName="startTime" type="time" class="w-full" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                <input pInputText formControlName="endTime" type="time" class="w-full" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-2">Expertise</label>
                <input pInputText formControlName="expertise" class="w-full" />
              </div>
            </ng-container>

            <!-- Address Fields -->
            <div class="field md:col-span-2" formGroupName="address">
              <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
              <div class="grid grid-cols-2 gap-4">
                <input pInputText formControlName="street" placeholder="Street" class="w-full" />
                <input pInputText formControlName="city" placeholder="City" class="w-full" />
                <input pInputText formControlName="state" placeholder="State" class="w-full" />
                <input pInputText formControlName="zipCode" placeholder="Zip Code" class="w-full" />
              </div>
            </div>

            <!-- Bio Field -->
            <div class="field md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">About/Bio</label>
              <textarea pInputTextarea formControlName="about" rows="4"
                class="w-full min-h-[120px] border border-gray-300 rounded-md p-3">
              </textarea>
            </div>
          </div>

          <div class="flex justify-end pt-4 border-t">
            <p-button type="submit" label="Save Changes" icon="ri-save-line" [loading]="saving"></p-button>
          </div>
        </form>
      </div>
    </p-tabPanel>

    <!-- Role-Specific Tabs -->
    <ng-container *ngFor="let tab of getRoleSpecificTabs()">
      <p-tabPanel [header]="formatTabHeader(tab)">
        <ng-container [ngTemplateOutlet]="getTabContent(tab)"></ng-container>
      </p-tabPanel>
    </ng-container>

    <!-- Security Tab -->
    <p-tabPanel header="Security">
      <div class="space-y-6">
        <!-- Change Password -->
        <div class="p-6 bg-gray-50 rounded-lg">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-4">Change Password</h3>
          <form [formGroup]="passwordForm" class="space-y-4" (ngSubmit)="updatePassword()">
            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
              <p-password formControlName="currentPassword" [toggleMask]="true" styleClass="w-full"></p-password>
              <small class="text-red-500"
                *ngIf="passwordForm.get('currentPassword')?.errors?.['required'] && passwordForm.get('currentPassword')?.touched">
                Current password is required
              </small>
            </div>

            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
              <p-password formControlName="newPassword" [toggleMask]="true" [feedback]="true"
                styleClass="w-full"></p-password>
              <small class="text-red-500"
                *ngIf="passwordForm.get('newPassword')?.errors?.['required'] && passwordForm.get('newPassword')?.touched">
                New password is required
              </small>
            </div>

            <div class="field">
              <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
              <p-password formControlName="confirmPassword" [toggleMask]="true" styleClass="w-full"></p-password>
              <small class="text-red-500"
                *ngIf="passwordForm.get('confirmPassword')?.errors?.['required'] && passwordForm.get('confirmPassword')?.touched">
                Password confirmation is required
              </small>
            </div>

            <div class="flex justify-end pt-4 border-t">
              <p-button type="submit" label="Update Password" icon="ri-lock-password-line"
                [loading]="updatingPassword"></p-button>
            </div>
          </form>
        </div>
      </div>
    </p-tabPanel>

    <!-- Preferences Tab -->
    <p-tabPanel header="Preferences">
      <div class="space-y-6">
        <!-- Notification Preferences -->
        <div class="p-6 bg-gray-50 rounded-lg">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-4">Notification Preferences</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between p-3 hover:bg-gray-100 rounded-lg">
              <div>
                <p class="font-medium">Email Notifications</p>
                <p class="text-sm text-gray-600">Receive updates via email</p>
              </div>
              <p-inputSwitch [(ngModel)]="preferences.emailNotifications"></p-inputSwitch>
            </div>

            <div class="flex items-center justify-between p-3 hover:bg-gray-100 rounded-lg">
              <div>
                <p class="font-medium">SMS Notifications</p>
                <p class="text-sm text-gray-600">Receive updates via SMS</p>
              </div>
              <p-inputSwitch [(ngModel)]="preferences.smsNotifications"></p-inputSwitch>
            </div>

            <div class="flex items-center justify-between p-3 hover:bg-gray-100 rounded-lg">
              <div>
                <p class="font-medium">Appointment Reminders</p>
                <p class="text-sm text-gray-600">Get reminders before appointments</p>
              </div>
              <p-inputSwitch [(ngModel)]="preferences.appointmentReminders"></p-inputSwitch>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <p-button label="Save Preferences" icon="ri-save-line" (onClick)="savePreferences()"
            [loading]="savingPreferences"></p-button>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>

  <!-- Template for Appointments tab -->
  <ng-template #appointmentsTemplate>
    <div class="p-4 bg-gray-50 rounded-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Appointments</h3>
        <p-button *ngIf="userProfile.role.toLowerCase() === 'doctor'" label="Set Availability" icon="ri-calendar-line">
        </p-button>
      </div>

      <p-table [value]="appointments" [paginator]="true" [rows]="5" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Date & Time</th>
            <th>Patient</th>
            <th>Type</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-appointment>
          <tr>
            <td>{{appointment.datetime | date:'medium'}}</td>
            <td>
              <div class="flex items-center gap-2">
                <p-avatar [image]="appointment.photo" size="normal"></p-avatar>
                <span>{{appointment.name}}</span>
              </div>
            </td>
            <td>{{appointment.type}}</td>
            <td>
              <p-tag [value]="appointment.status" [severity]="getStatusSeverity(appointment.status)">
              </p-tag>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button icon="ri-eye-line" severity="secondary"></p-button>
                <p-button icon="ri-edit-line"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center p-4">
              No appointments found.
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </ng-template>

  <!-- Template for Prescriptions tab -->
  <ng-template #prescriptionsTemplate>
    <div class="p-4 bg-gray-50 rounded-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Prescriptions</h3>
      </div>

      <p-accordion>
        <p-accordionTab *ngFor="let prescription of prescriptions">
          <ng-template pTemplate="header">
            <div class="flex justify-between items-center w-full">
              <div>
                <span class="font-medium">{{prescription.date | date}}</span>
                <span class="text-gray-600 ml-4">Dr. {{prescription.doctorName}}</span>
              </div>
              <p-tag [value]="prescription.status" [severity]="getPrescriptionStatusSeverity(prescription.status)">
              </p-tag>
            </div>
          </ng-template>
          <div class="space-y-4">
            <div *ngFor="let medicine of prescription.medicines" class="p-3 bg-white rounded border">
              <div class="flex justify-between">
                <div>
                  <h4 class="font-medium">{{medicine.name}}</h4>
                  <p class="text-sm text-gray-600">{{medicine.dosage}}</p>
                  <p class="text-sm text-gray-600">{{medicine.frequency}}</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-600">Duration: {{medicine.duration}}</p>
                  <p class="text-sm text-gray-600">Quantity: {{medicine.quantity}}</p>
                </div>
              </div>
            </div>
            <div class="text-sm text-gray-600">
              <strong>Notes:</strong> {{prescription.notes}}
            </div>
          </div>
        </p-accordionTab>
      </p-accordion>
      
      <div *ngIf="prescriptions.length === 0" class="p-4 text-center bg-white rounded-lg">
        No prescriptions found.
      </div>
    </div>
  </ng-template>

  <!-- Photo Upload Dialog -->
  <p-dialog [(visible)]="showPhotoUpload" header="Update Profile Photo" [modal]="true" [style]="{width: '450px'}">
    <p-fileUpload mode="advanced" [maxFileSize]="1000000" accept="image/*" [customUpload]="true"
      (uploadHandler)="onPhotoUpload($event)" [auto]="true" chooseLabel="Choose Photo">
    </p-fileUpload>
  </p-dialog>
</div>

<p-toast position="top-right"></p-toast>